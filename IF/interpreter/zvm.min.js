/*

ZVM - the ifvms.js Z-Machine (versions 5 and 8)
===============================================

Built: 2016-07-21

Copyright (c) 2011-2016 The ifvms.js team
BSD licenced
http://github.com/curiousdannii/ifvms.js

*/
var ZVM=function(){"use strict";function t(t,e){return t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3]}function e(t){return[255&t>>24,255&t>>16,255&t>>8,255&t]}function r(t,e){return String.fromCharCode(t[e],t[e+1],t[e+2],t[e+3])}function n(t){return[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]}function s(t,e){return Function.prototype.bind?t.bind(e):function(){t.apply(e,[].slice.call(arguments))}}function i(t,e){for(var r in e)t[r]=e[r];return t}function o(t){return t<<16>>16}function a(t){return 65535&t}function _(t){for(var e=0,r=t.length,n=[];r>e;)n[e/2]=t[e++]<<8|t[e++];return n}function h(t){return t.replace(/(e\.)?U2S\(([^(]+?)\)/g,"(($2)<<16>>16)").replace(/(e\.)?S2U\(([^(]+?)\)/g,"(($2)&65535)").replace(/([\w.]+)\.getUint8\(([^(]+?)\)/g,"$1[$2]").replace(/([\w.]+)\.getUint16\(([^(]+?)\)/g,"($1[$2]<<8|$1[$2+1])")}function c(t,e){var r,n,s=[];for(r in t)e.indexOf(r)>=0&&(n=/function\s*\(([^(]*)\)\s*\{([\s\S]+)\}/.exec(""+t[r]),s.push(r+":function("+n[1]+"){"+h(n[2])+"}"));i(t,eval("({"+s.join()+"})"))}function u(t,e,r){return r=r||{},e&&(r.func=e),t.subClass(r)}function l(t,e){for(var r,n,s,i,a,_=0;t.ops.length-1>_;){if(t.ops[_].offset===e){if(2===t.ops.length-_&&t.ops[_+1].offset)return i=t.ops.pop(),a=t.ops.pop(),a.cond.invert=!a.cond.invert,i.cond=new T([a.cond,i.cond],"&&"),i.labels=a.labels.concat(i.labels),t.ops.push(i),1;r=new I(t.e,t.ops[_+1].pc),r.ops=t.ops.slice(_+1),n=r.ops.length-1,t.ops.length=_+1,s=t.ops[_],s.result=r,s.cond.invert=!s.cond.invert,i=r.ops[n],140===i.code&&o(i.operands[0].v)+i.next-2===s.pc?(s.keyword="while",r.ops.pop()):r.stopper=i.stopper;return 1}_++}}function m(t){return""+t}var f=function(){var t,e,r=0,n=/\b_super\b/,s=function(){};for(e in{toString:1})t=1;return s.subClass=function(e){var i,o,a,_=this.prototype,h=!/native code/.test(""+e.toString)&&e.toString,c=function(t,e){return function(){var r,n=this._super;return this._super=_[t],r=e.apply(this,arguments),this._super=n,r}};r=1,i=new this,r=0;for(o in e)i[o]="function"==typeof e[o]&&"function"==typeof _[o]&&n.test(e[o])?c(o,e[o]):e[o];return!t&&h&&(i.toString=n.test(h)?c("toString",h):h),a=i.init?function(){r||this.init.apply(this,arguments)}:function(){},a.prototype=i,a.constructor=a,a.subClass=s.subClass,a},s}(),d=f.subClass({init:function p(e){if(this.type="",this.chunks=[],e){if("FORM"!==r(e,0))throw Error("Not an IFF file");this.type=r(e,8);for(var n=12,s=e.length;s>n;){var i=t(e,n+4);if(0>i||i+n>s)throw Error("IFF: Chunk out of range");this.chunks.push({type:r(e,n),offset:n,data:e.slice(n+8,n+8+i)}),n+=8+i,i%2&&n++}}},write:function g(){for(var t=n(this.type),r=0,s=this.chunks.length;s>r;r++){var i=this.chunks[r],o=i.data,a=o.length;t=t.concat(n(i.type),e(a),o),a%2&&t.push(0)}return n("FORM").concat(e(t.length),t)}});d.num_from=t,d.num_to_word=e,d.text_from=r,d.text_to_word=n,[].indexOf||(Array.prototype.indexOf=function(t,e){for(var r=e||0,n=this.length;n>r;r++)if(this[r]===t)return r;return-1});var v=v!==void 0?v:{log:function(){},info:function(){},warn:function(){}},b,y,F=0,U=F?function(t){var e=new ArrayBuffer(t);return t=new DataView(e),t.buffer=e,t}:function(t){return t=t.slice(),ZVM?i(t,{data:t,getUint8:function(e){return t[e]},getUint16:function(e){return t[e]<<8|t[e+1]},getBuffer:function(e,r){return t.slice(e,e+r)},getBuffer16:function(e,r){return _(t.slice(e,e+2*r))},setUint8:function(e,r){return t[e]=255&r},setUint16:function(e,r){return t[e]=255&r>>8,t[e+1]=255&r,65535&r},setBuffer:function(e,r){for(var n=0,s=r.length;s>n;)t[n+e]=r[n++]}}):void 0},C=f.subClass({init:function(t,e){this.e=t,this.v=e},toString:function(){return this.v},U2S:function(){return o(this.v)}}),S=C.subClass({toString:function(){var t=this.v;return this.indirect?"e.indirect("+t+")":0===t?"s.pop()":15>--t?"l["+t+"]":"m.getUint16("+(this.e.globals+2*(t-15))+")"},store:function(t){var e=this.v;return this.indirect?"e.indirect("+e+","+t+")":this.returnval?"e.variable("+e+","+t+")":0===e?"s.push("+t+")":15>--e?"l["+e+"]="+t:"m.setUint16("+(this.e.globals+2*(e-15))+","+t+")"},U2S:function(){return"e.U2S("+this+")"}}),E=f.subClass({init:function(t,e,r,n,s,i){this.e=t,this.context=e,this.code=r,this.pc=n,this.labels=[this.pc+"/"+this.code],this.next=s,this.operands=i,this.post&&this.post()},toString:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},args:function(t){return this.operands.join(t)},label:function(){return"/* "+this.labels.join()+" */ "}}),w=E.subClass({stopper:1}),k=w.subClass({storer:1,post:function(){this.storer=this.operands.pop(),this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return"e.pc="+this.next+";"+this.origfunc.apply(this,arguments)}}),T=f.subClass({init:function(t,e){this.ops=t||[],this.code=e||"||"},toString:function(){for(var t,e=0,r=[];this.ops.length>e;)t=this.ops[e++],r.push(t.func?(t.iftrue?"":"!(")+t.func.apply(t,t.operands)+(t.iftrue?"":")"):t);return(this.invert?"(!(":"(")+r.join(this.code)+(this.invert?"))":")")}}),Z=E.subClass({brancher:1,keyword:"if",post:function(){var t,e,r=this.operands.pop(),n=r[1];this.iftrue=r[0],0===n||1===n?t="e.ret("+n+")":(n+=this.next-2,this.context.targets.push(n),t="e.pc="+n),this.result=t+";return",this.offset=n,this.cond=new T([this]),this.context.ops.length&&(e=this.context.ops.pop(),e.offset===n?(this.cond.ops.unshift(e.cond),this.labels=e.labels,this.labels.push(this.pc+"/"+this.code)):this.context.ops.push(e))},toString:function(){var t=this.result;return t instanceof I&&(t+=t.stopper?"; return":"",this.result.ops.length>1&&(t="\n"+t+"\n")),this.label()+this.keyword+this.cond+" {"+t+"}"}}),x=Z.subClass({storer:1,post:function(){this._super(),this.storer=this.operands.pop(),this.storer.returnval=1,this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return this.storer.store(this.origfunc.apply(this,arguments))}}),N=E.subClass({storer:1,post:function(){this.storer=this.operands.pop()},toString:function(){var t=this._super();return this.storer?this.storer.store(t):t}}),j=w.subClass({result:{v:-1},toString:function(){return this.label()+"e.call("+this.operands.shift()+","+this.result.v+","+this.next+",["+this.args()+"])"}}),O=j.subClass({storer:1,post:function(){this.result=this.operands.pop()}}),I=f.subClass({init:function(t,e){this.e=t,this.pc=e,this.pre=[],this.ops=[],this.post=[],this.targets=[]},toString:function(){return this.pre.join("")+this.ops.join(";")+this.post.join("")}}),R=I.subClass({toString:function(){return this.pre.unshift("var l=e.l,m=e.m,s=e.s;\n"),this._super()}}),A=d.subClass({init:function(t){if(this._super(t),t){if("IFZS"!==this.type)throw Error("Not a Quetzal savefile");for(var e=0,r=this.chunks.length;r>e;e++){var n=this.chunks[e].type,s=this.chunks[e].data;"CMem"===n||"UMem"===n?(this.memory=s,this.compressed="CMem"===n):"Stks"===n?this.stacks=s:"IFhd"===n&&(this.release=s.slice(0,2),this.serial=s.slice(2,8),this.checksum=s.slice(8,10),this.pc=s[10]<<16|s[11]<<8|s[12])}}},write:function(){this.type="IFZS";var t=this.pc,e=this.release.concat(this.serial,this.checksum,255&t>>16,255&t>>8,255&t);return this.chunks=[{type:"IFhd",data:e},{type:this.compressed?"CMem":"UMem",data:this.memory},{type:"Stks",data:this.stacks}],this._super()}}),z=f.subClass({init:function(t,e){this.e=t,this.buffer="",i(this,this.formatters[t.env.formatter]||{}),this.mono=e,this.process_colours(),this.currentwin=0,this.status=[],t.orders.push({code:"stream",name:"status"},{code:"stream",name:"main"},{code:"find",name:"main"})},clear_window:function(){this.e.orders.push({code:"clear",name:"main",bg:this.bg})},erase_line:function(t){1===t&&(this.flush(),this.status.push({code:"eraseline"}))},erase_window:function(t){this.flush(),1>t&&this.clear_window(),-1===t&&this.split_window(0),(-2===t||1===t)&&this.status.push({code:"clear"})},flush:function(){if(""!==this.buffer){var t={code:"stream",text:this.buffer,props:this.format()};(this.currentwin?this.status:this.e.orders).push(t),this.buffer=""}},format:function(){var t,e={},r=[],n=this.fg,s=this.bg;return this.bold&&r.push("zvm-bold"),this.italic&&r.push("zvm-italic"),this.mono&&r.push("zvm-mono"),this.reverse&&(t=n,n=s||this.env.bg,s=t||this.env.fg),n!==void 0&&(isNaN(n)?e.css={color:n}:r.push("zvm-fg-"+n)),s!==void 0&&(isNaN(s)?(e.css||(e.css={}),e.css["background-color"]=s):r.push("zvm-bg-"+s)),r.length&&(e["class"]=r.join(" ")),e},get_cursor:function(t){this.status.push({code:"get_cursor",addr:t}),this.e.act()},process_colours:function(){function t(t){var e,r=Math.round,n=/(\d+),\s*(\d+),\s*(\d+)|#(\w{1,2})(\w{1,2})(\w{1,2})/.exec(t);return n[1]?e=[n[1],n[2],n[3]]:(e=[parseInt(n[4],16),parseInt(n[5],16),parseInt(n[6],16)],4===t.length&&(e=[e[0]<<4|e[0],e[1]<<4|e[1],e[2]<<4|e[2]])),r(e[2]/8.226)<<10|r(e[1]/8.226)<<5|r(e[0]/8.226)}var e=[65534,65535,0,29,832,957,22944,31775,30624,32767,23254,17969,11627],r=this.e.env.fgcolour,n=this.e.env.bgcolour,s=r?t(r):65535,i=n?t(n):65535,o=e.indexOf(s),a=e.indexOf(i);2>o&&(o=r||2),2>a&&(a=n||9),this.env={fg:o,bg:a,fg_true:s,bg_true:i}},set_colour:function(t,e){this.flush(),1===t&&(this.fg=void 0),t>1&&13>t&&(this.fg=t),1===e&&(this.bg=void 0),e>1&&13>e&&(this.bg=e)},set_cursor:function(t,e){this.flush(),this.status.push({code:"cursor",to:[t-1,e-1]})},set_font:function(t){if(1!==t&&4!==t)return 0;var e=4&this.mono?4:1;return t!==e&&(this.flush(),this.mono^=4),e},set_style:function(t){this.flush(),0===t&&(this.reverse=this.bold=this.italic=0,this.mono&=254),1&t&&(this.reverse=1),2&t&&(this.bold=1),4&t&&(this.italic=1),8&t&&(this.mono|=1)},set_true_colour:function(t,e){function r(t){var e=Math.round(8.226*(31&t))<<16|Math.round(8.226*((992&t)>>5))<<8|Math.round(8.226*((31744&t)>>10));for(e=e.toString(16);6>e.length;)e="0"+e;return"#"+e}this.flush(),65535===t?this.fg=void 0:32768>t&&(this.fg=r(t)),65535===e?this.bg=void 0:32768>e&&(this.bg=r(e))},set_window:function(t){this.flush(),this.currentwin=t,this.e.orders.push({code:"find",name:t?"status":"main"}),t&&this.status.push({code:"cursor",to:[0,0]})},split_window:function(t){this.flush(),this.status.push({code:"height",lines:t})},update_header:function(){var t=this.e.m;t.setUint8(44,isNaN(this.env.bg)?1:this.env.bg),t.setUint8(45,isNaN(this.env.fg)?1:this.env.fg),this.e.extension_table(5,this.env.fg_true),this.e.extension_table(6,this.env.bg_true)},formatters:{}}),W=u(Z,function(){return 1}),G=N.subClass({storer:0,post:function(){var t=this.operands,e=t[0],r=e instanceof S;t[0]=new S(this.e,r?e:e.v),(r||0===e.v)&&(t[0].indirect=1),this.storer=142===this.code?t.pop():t.shift(),0===t.length&&t.push(new S(this.e,0))},func:m}),B=E.subClass({func:function(t){var e=t.v-1,r=this.code%2?1:-1;return t instanceof S||e>14?"e.incdec("+t+","+r+")":(0>e?"e.s[e.s.length-1]=e.S2U(e.s[e.s.length-1]+":"e.l["+e+"]=e.S2U(e.l["+e+"]+")+r+")"}}),D={1:u(Z,function(){return 2===arguments.length?this.args("==="):"e.jeq("+this.args()+")"}),2:u(Z,function(t,e){return t.U2S()+"<"+e.U2S()}),3:u(Z,function(t,e){return t.U2S()+">"+e.U2S()}),4:u(Z,function(t,e){return"e.U2S(e.incdec("+t+",-1))<"+e.U2S()}),5:u(Z,function(t,e){return"e.U2S(e.incdec("+t+",1))>"+e.U2S()}),6:u(Z,function(){return"e.jin("+this.args()+")"}),7:u(Z,function(){return"e.test("+this.args()+")"}),8:u(N,function(){return this.args("|")}),9:u(N,function(){return this.args("&")}),10:u(Z,function(){return"e.test_attr("+this.args()+")"}),11:u(E,function(){return"e.set_attr("+this.args()+")"}),12:u(E,function(){return"e.clear_attr("+this.args()+")"}),13:G,14:u(E,function(){return"e.insert_obj("+this.args()+")"}),15:u(N,function(t,e){return"m.getUint16(e.S2U("+t+"+2*"+e.U2S()+"))"}),16:u(N,function(t,e){return"m.getUint8(e.S2U("+t+"+"+e.U2S()+"))"}),17:u(N,function(){return"e.get_prop("+this.args()+")"}),18:u(N,function(){return"e.find_prop("+this.args()+")"}),19:u(N,function(){return"e.find_prop("+this.args(",0,")+")"}),20:u(N,function(){return"e.S2U("+this.args("+")+")"}),21:u(N,function(){return"e.S2U("+this.args("-")+")"}),22:u(N,function(){return"e.S2U("+this.args("*")+")"}),23:u(N,function(t,e){return"e.S2U(parseInt("+t.U2S()+"/"+e.U2S()+"))"}),24:u(N,function(t,e){return"e.S2U("+t.U2S()+"%"+e.U2S()+")"}),25:O,26:j,27:u(E,function(){return"e.ui.set_colour("+this.args()+")"}),28:u(w,function(t,e){return"while(e.call_stack.length>"+e+"){e.call_stack.shift()}return "+t}),128:u(Z,function(t){return t+"===0"}),129:u(x,function(t){return"e.get_sibling("+t+")"}),130:u(x,function(t){return"e.get_child("+t+")"}),131:u(N,function(t){return"e.get_parent("+t+")"}),132:u(N,function(t){return"e.get_prop_len("+t+")"}),133:B,134:B,135:u(E,function(t){return"e.print(2,"+t+")"}),136:O,137:u(E,function(t){return"e.remove_obj("+t+")"}),138:u(E,function(t){return"e.print(3,"+t+")"}),139:u(w,function(t){return"return "+t}),140:u(w,function(t){return"e.pc="+t.U2S()+"+"+(this.next-2)}),141:u(E,function(t){return"e.print(2,"+t+"*"+this.e.addr_multipler+")"}),142:G.subClass({storer:1}),143:j,176:u(w,function(){return"return 1"}),177:u(w,function(){return"return 0"}),178:u(E,function(t){return"e.print(2,"+t+")"},{printer:1}),179:u(w,function(t){return"e.print(2,"+t+");e.print(1,13);return 1"},{printer:1}),180:E,183:u(w,function(){return"e.act(183)"}),184:u(w,function(t){return"return "+t},{post:function(){this.operands.push(new S(this.e,0))}}),185:u(N,function(){return"e.call_stack.length"}),186:u(w,function(){return"e.act(186)"}),187:u(E,function(){return"e.print(1,13)"}),189:W,191:W,224:O,225:u(E,function(t,e,r){return"m.setUint16(e.S2U("+t+"+2*"+e.U2S()+"),"+r+")"}),226:u(E,function(t,e,r){return"m.setUint8(e.S2U("+t+"+"+e.U2S()+"),"+r+")"}),227:u(E,function(){return"e.put_prop("+this.args()+")"}),228:u(k,function(){return"e.read("+this.args()+","+this.storer.v+")"}),229:u(E,function(t){return"e.print(4,"+t+")"}),230:u(E,function(t){return"e.print(0,"+t.U2S()+")"}),231:u(N,function(t){return"e.random("+t.U2S()+")"}),232:u(N,m,{post:function(){this.storer=new S(this.e,0)},storer:0}),233:G,234:u(E,function(t){return"e.ui.split_window("+t+")"}),235:u(E,function(t){return"e.ui.set_window("+t+")"}),236:O,237:u(E,function(t){return"e.ui.erase_window("+t.U2S()+")"}),238:u(E,function(t){return"e.ui.erase_line("+t+")"}),239:u(E,function(){return"e.ui.set_cursor("+this.args()+")"}),240:u(k,function(t){return"e.ui.get_cursor("+t+")"}),241:u(E,function(t){return"e.ui.set_style("+t+")"}),242:E,243:u(E,function(){return"e.output_stream("+this.args()+")"}),244:E,245:E,246:u(k,function(){return"e.read_char("+(this.args()||"1")+","+this.storer.v+")"}),247:u(x,function(){return"e.scan_table("+this.args()+")"}),248:u(N,function(t){return"e.S2U(~"+t+")"}),249:j,250:j,251:u(E,function(){return"e.tokenise("+this.args()+")"}),252:u(E,function(){return"e.encode_text("+this.args()+")"}),253:u(E,function(){return"e.copy_table("+this.args()+")"}),254:u(E,function(){return"e.print_table("+this.args()+")"}),255:u(Z,function(t){return t+"<=e.call_stack[0][4]"}),1e3:u(k,function(){return"e.save("+(this.next-1)+","+this.storer.v+")"}),1001:u(k,function(){return"e.act(1001,"+this.storer.v+")"}),1002:u(N,function(t,e){return"e.S2U(e.log_shift("+t+","+e.U2S()+"))"}),1003:u(N,function(t,e){return"e.S2U(e.art_shift("+t.U2S()+","+e.U2S()+"))"}),1004:u(N,function(t){return"e.ui.set_font("+t+")"}),1009:u(N,function(){return"e.save_undo("+this.next+","+this.storer.v+")"}),1010:u(E,function(){return"if(e.restore_undo())return"},{storer:1}),1011:u(E,function(t){return"e.print(1,"+t+")"}),1012:u(N,function(){return 3}),1013:u(E,function(){return"e.ui.set_true_colour("+this.args()+")"}),1014:E.subClass({brancher:1}),1030:u(N,function(){return"e.gestalt("+this.args()+")"})},M=f.subClass({art_shift:function(t,e){return e>0?t<<e:t>>-e},call:function(t,e,r,n){if(0===t)return e>=0&&this.variable(e,0),this.pc=r;var s,i,o=this.l.length,a=n.length;for(this.pc=t*this.addr_multipler,i=this.m.getUint8(this.pc++),n=n.slice(0,i),s=n.length;i>s;s++)n.push(0);this.l=n.concat(this.l),this.call_stack.unshift([r,e,i,this.s.length,a,o])},clear_attr:function(t,e){var r=0|this.objects+14*t+e/8;this.m.setUint8(r,this.m.getUint8(r)&~(128>>e%8))},copy_table:function(t,e,r){r=o(r);var n=this.m,s=0,i=0>r;if(r=Math.abs(r),0!==e)if(i)for(;r>s;)n.setUint8(e+s,n.getUint8(t+s++));else n.setBuffer(e,n.getBuffer(t,r));else for(;r>s;)n.setUint8(t+s++,0)},encode_text:function(t,e,r,n){this.m.setBuffer(n,this.encode(this.m.getBuffer(t+r,e)))},extension_table:function(t,e){var r=this.extension;return!r||t>this.extension_count?0:(r+=2*t,void 0===e?this.m.getUint16(r):(this.e.setUint16(r,e),void 0))},find_prop:function(t,e,r){var n,s,i=this.m,o=0,a=i.getUint16(this.objects+14*t+12);for(a+=2*i.getUint8(a)+1;;){if(n=i.getUint8(a),s=63&n,o===r)return s;if(s===e)return a+(128&n?2:1);if(e>s)return 0;o=s,128&n?(s=63&i.getUint8(a+1),a+=s?s+2:66):a+=64&n?3:2}},gestalt:function(t){switch(t){case 1:return 258;case 8192:return 1;case 8193:case 8194:return 2}return 0},get_child:function(t){return this.m.getUint16(this.objects+14*t+10)},get_sibling:function(t){return this.m.getUint16(this.objects+14*t+8)},get_parent:function(t){return this.m.getUint16(this.objects+14*t+6)},get_prop:function(t,e){var r=this.m,n=this.find_prop(t,e);return n?(64&r.getUint8(n-1)?r.getUint16:r.getUint8)(n):r.getUint16(this.properties+2*(e-1))},get_prop_len:function(t){if(0===t)return 0;var e=this.m.getUint8(t-1);return 128&e?(e&=63,0===e?64:e):64&e?2:1},incdec:function(t,e){var r,n;return 0===t?(r=a(this.s.pop()+e),this.s.push(r),r):15>--t?this.l[t]=a(this.l[t]+e):(n=this.globals+2*(t-15),this.m.setUint16(n,this.m.getUint16(n)+e))},indirect:function(t,e){return 0===t?arguments.length>1?this.s[this.s.length-1]=e:this.s[this.s.length-1]:this.variable(t,e)},insert_obj:function(t,e){this.remove_obj(t),this.set_family(t,e,e,t,t,this.get_child(e))},jeq:function(){for(var t=1;arguments.length>t;)if(arguments[t++]===arguments[0])return 1},jin:function(t,e){return this.get_parent(t)===e},log_shift:function(t,e){return e>0?t<<e:t>>>-e},output_stream:function(t,e){if(t=o(t),1===t&&(this.streams[0]=1),-1===t&&(this.streams[0]=0),3===t&&this.streams[2].unshift([e,""]),-3===t){var r=this.streams[2].shift(),n=this.text_to_zscii(r[1]);this.m.setUint16(r[0],n.length),this.m.setBuffer(r[0]+2,n)}},_print:function(t){if(this.streams[2].length)this.streams[2][0][1]+=t;else if(this.streams[0]){var e=2&this.m.getUint8(17);e!==(2&this.ui.mono)&&(253&this.ui.mono||this.ui.flush(),this.ui.mono^=2),this.ui.buffer+=t}},print:function(t,e){if(0===t&&(e=""+e),1===t&&(e=String.fromCharCode(e)),2===t&&(e=this.jit[e]||this.decode(e)),3===t){var r=this.m.getUint16(this.objects+14*e+12);e=this.decode(r+1,2*this.m.getUint8(r))}if(4===t){if(!this.unicode_table[e])return;e=this.unicode_table[e]}this._print(e)},print_table:function(t,e,r,n){r=r||1,n=n||0;for(var s=0;r>s++;)this._print(this.zscii_to_text(this.m.getBuffer(t,e))+(r>s?"\r":"")),t+=e+n},put_prop:function(t,e,r){var n=this.m,s=this.find_prop(t,e);(64&n.getUint8(s-1)?n.setUint16:n.setUint8)(s,r)},random:function(t){var e=this.xorshift_seed;return 1>t?(this.xorshift_seed=t,0):0===e?0|1+Math.random()*t:(e^=e<<13,e^=e>>17,this.xorshift_seed=e^=e<<5,1+(32767&e)%t)},read:function(t,e,r,n,s){3===arguments.length&&(s=r,r=n=0),this.act("read",{buffer:t,parse:e,len:this.m.getUint8(t),initiallen:this.m.getUint8(t+1),time:r,routine:n,storer:s})},read_char:function(t,e,r,n){2===arguments.length&&(n=e,e=r=0),this.act("char",{time:e,routine:r,storer:n})},remove_obj:function(t){var e,r,n,s=this.get_parent(t);if(0!==s)if(e=this.get_child(s),r=this.get_sibling(t),e===t)this.set_family(t,0,s,r);else{for(;;){if(n=this.get_sibling(e),n===t)break;e=n}this.set_family(t,0,0,0,e,r)}},restart:function(){var t=U(this.data),e=t.getUint8(0),r=5===e?4:8,n=t.getUint16(10),s=t.getUint16(54);if(5!==e&&8!==e)throw Error("Unsupported Z-Machine version: "+e);this.m&&t.setUint8(17,this.m.getUint8(17)),i(this,{m:t,s:[],l:[],call_stack:[],undo:[],orders:[],streams:[1,0,[],0],version:e,pc:t.getUint16(6),properties:n,objects:n+112,globals:t.getUint16(12),staticmem:t.getUint16(14),eof:(t.getUint16(26)||65536)*r,extension:s,extension_count:s?t.getUint16(s):0,addr_multipler:r}),this.ui=new z(this,2&t.getUint8(17)),this.init_text(),this.update_header()},restore:function(t){var e,r,n=new A(t),s=n.memory,i=n.stacks,o=n.pc,a=this.m.getUint8(17),h=0,c=0,u=[],l=[];if(this.m.setBuffer(0,this.data.slice(0,this.staticmem)),n.compressed)for(;s.length>h;)e=s[h++],0===e?c+=1+s[h++]:this.m.setUint8(c,e^this.data[c++]);else this.m.setBuffer(0,s);for(this.m.setUint8(17,a),h=6,e=i[h++]<<8|i[h++],r=_(i.slice(h,e));i.length>h;){for(u.unshift([i[h++]<<16|i[h++]<<8|i[h++],0,0,r.length,0,l.length]),u[0][1]=16&i[h]?-1:i[h+1],u[0][2]=15&i[h],h+=2,e=i[h++];e;)u[0][4]++,e>>=1;e=2*(i[h++]<<8|i[h++]),l=_(i.slice(h,h+=2*u[0][2])).concat(l),r=r.concat(_(i.slice(h,h+=e)))}this.call_stack=u,this.l=l,this.s=r,this.update_header(),this.variable(this.m.getUint8(o++),2),this.pc=o},restore_undo:function(){if(0===this.undo.length)return 0;var t=this.undo.pop();return this.pc=t[0],t[2][17]=this.m.getUint8(17),this.m.setBuffer(0,t[2]),this.l=t[3],this.s=t[4],this.call_stack=t[5],this.variable(t[1],2),1},ret:function(t){var e=this.call_stack.shift(),r=e[1];this.pc=e[0],this.l=this.l.slice(this.l.length-e[5]),this.s.length=e[3],r>=0&&this.variable(r,0|t)},save:function(t,e){var r,n,s,i,o,a=this.m,_=this.s,h=this.l,c=new A,u=[],l=0,m=this.call_stack.reverse(),f=[0,0,0,0,0,0];for(c.release=a.getBuffer(2,2),c.serial=a.getBuffer(18,6),c.checksum=a.getBuffer(28,2),c.pc=t,c.compressed=1,r=0;this.staticmem>r;r++)s=a.getUint8(r)^this.data[r],0===s?256===++l&&(u.push(0,255),l=0):(l&&(u.push(0,l-1),l=0),u.push(s));for(c.memory=u,f.push(m[0][3]>>8,255&m[0][3]),n=0;m[0][3]>n;n++)f.push(_[n]>>8,255&_[n]);for(r=0;m.length>r;r++){for(i=m[r],o=(m[r+1]?m[r+1][3]:_.length)-i[3],f.push(i[0]>>16,255&i[0]>>8,255&i[0],i[2]|(0>i[1]?16:0),0>i[1]?0:i[1],(1<<i[4])-1,o>>8,255&o),n=h.length-i[5]-i[2];h.length-i[5]>n;n++)f.push(h[n]>>8,255&h[n]);for(n=i[3];i[3]+o>n;n++)f.push(_[n]>>8,255&_[n])}m.reverse(),c.stacks=f,this.act("save",{data:c.write(),storer:e})},save_undo:function(t,e){return this.undo.push([t,e,this.m.getBuffer(0,this.staticmem),this.l.slice(),this.s.slice(),this.call_stack.slice()]),1},scan_table:function(t,e,r,n){n=n||130;var s=128&n?this.m.getUint16:this.m.getUint8;for(n&=127,r=e+r*n;r>e;){if(s(e)===t)return e;e+=n}return 0},set_attr:function(t,e){var r=0|this.objects+14*t+e/8;this.m.setUint8(r,this.m.getUint8(r)|128>>e%8)},set_family:function(t,e,r,n,s,i){this.m.setUint16(this.objects+14*t+6,e),r&&this.m.setUint16(this.objects+14*r+10,n),s&&this.m.setUint16(this.objects+14*s+8,i)},test:function(t,e){return t&e===e},test_attr:function(t,e){return 128&this.m.getUint8(0|this.objects+14*t+e/8)<<e%8},update_header:function(){var t=this.m;this.xorshift_seed=0,t.setUint8(1,29|(this.env.timed?128:0)),t.setUint8(17,87&t.getUint8(17)),t.setUint8(32,255),t.setUint8(33,this.env.width),t.setUint16(34,this.env.width),t.setUint16(36,255),t.setUint16(38,257),t.setUint16(50,258),this.extension_table(4,0),this.ui.update_header()},variable:function(t,e){var r,n=void 0!==e;if(0===t){if(!n)return this.s.pop();this.s.push(e)}else if(15>--t){if(!n)return this.l[t];this.l[t]=e}else{if(r=this.globals+2*(t-15),!n)return this.m.getUint16(r);this.m.setUint16(r,e)}return e},U2S:o,S2U:a,init_text:function(){function t(t){for(var e=[[],[],[]],n=0;78>n;)e[0|n/26][n%26]=t[n++];e[2][1]=13,r.alphabets=e}function e(t){for(var e={13:"\r"},n={13:13},s=0;t.length>s;)e[155+s]=String.fromCharCode(t[s]),n[t[s]]=155+s++;for(s=32;127>s;)e[s]=String.fromCharCode(s),n[s]=s++;r.unicode_table=e,r.reverse_unicode_table=n}var r=this,n=this.m,s=n.getUint16(52),i=this.extension_table(3),o=i&&n.getUint8(i++);t(s?n.getBuffer(s,78):this.text_to_zscii("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ \r0123456789.,!?_#'\"/\\-:()",1)),e(i?n.getBuffer16(i,o):this.text_to_zscii(unescape("%E4%F6%FC%C4%D6%DC%DF%BB%AB%EB%EF%FF%CB%CF%E1%E9%ED%F3%FA%FD%C1%C9%CD%D3%DA%DD%E0%E8%EC%F2%F9%C0%C8%CC%D2%D9%E2%EA%EE%F4%FB%C2%CA%CE%D4%DB%E5%C5%F8%D8%E3%F1%F5%C3%D1%D5%E6%C6%E7%C7%FE%F0%DE%D0%A3%u0153%u0152%A1%BF"),1)),this.dictionaries={},this.dict=n.getUint16(8),this.parse_dict(this.dict)},decode:function(t,e){var r,n,i,o,a=this.m,_=t,h=[],c=0,u=0,l=[],m=[],f=0;if(this.jit[t])return this.jit[t];for(e=e?e+t:this.eof;e>t&&(r=a.getUint16(t),t+=2,h.push(31&r>>10,31&r>>5,31&r),!(32768&r)););for(;h.length>c;){if(n=h[c++],0===n)l.push(32);else if(4>n)i=1,l.push(-1),m.push("\ue000+this.abbr("+(32*(n-1)+h[c++])+")+\ue000");else if(6>n)u=n;else if(2===u&&6===n){if(h.length>c+1)if(o=h[c++]<<5|h[c++],768>o)l.push(o);else{for(o-=767,f+=o,r=c,c=c%3+3;o--;)l.push(-1),m.push(String.fromCharCode(h[c]<<10|h[c+1]<<5|h[c+2])),h[c++]=h[c++]=h[c++]=32;c=r}}else 32>n&&l.push(this.alphabets[u][n-6]);u=4>u?0:u-3,0===c%3&&(c+=f,f=0)}return l=this.zscii_to_text(l,m),i&&(l={toString:s(Function('return"'+l.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\r/g,"\\r").replace(/\uE000/g,'"')+'"'),this)}),_>=this.staticmem&&(this.jit[_]=l),l},encode:function(t){for(var e,r,n=this.alphabets,s=[],i=0,o=[];9>s.length;)e=t[i++],32===e?s.push(0):(r=n[0].indexOf(e))>=0?s.push(r+6):(r=n[1].indexOf(e))>=0?s.push(4,r+6):(r=n[2].indexOf(e))>=0?s.push(5,r+6):(r=this.reverse_unicode_table[e])?s.push(5,6,r>>5,31&r):void 0===e&&s.push(5);for(s.length=9,i=0;9>i;)o.push(s[i++]<<2|s[i]>>3,(7&s[i++])<<5|s[i++]);return o[4]|=128,o},zscii_to_text:function(t,e){for(var r,n=0,s=t.length,i=0,o="";s>n;)r=t[n++],-1===r&&(o+=e[i++]),(r=this.unicode_table[r])&&(o+=r);return o},text_to_zscii:function(t,e){for(var r,n=[],s=0,i=t.length;i>s;)r=t.charCodeAt(s++),e||(r=this.reverse_unicode_table[r]||63),n.push(r);return n},parse_dict:function(t){var e,r,n=this.m,s=t,i={},o=n.getUint8(t++);for(i.separators=n.getBuffer(t,o),t+=o,e=n.getUint8(t++),r=t+2+e*n.getUint16(t),t+=2;r>t;)i[""+n.getBuffer(t,6)]=t,t+=e;return this.dictionaries[s]=i,i},abbr:function(t){var e=this.m;return this.decode(2*e.getUint16(e.getUint16(24)+2*t))},tokenise:function(t,e,r,n){r=r||this.dict,r=this.dictionaries[r]||this.parse_dict(r);for(var s,i,o=this.m,a=2,_=a+o.getUint8(t+1),h=r.separators,c=[],u=[],l=a,m=0;_>a;)s=o.getUint8(t+a++),32===s||h.indexOf(s)>=0?(c.length&&(u.push([c,l]),l+=c.length,c=[]),32!==s&&u.push([[s],l]),l++):c.push(s);for(c.length&&u.push([c,l]),i=Math.min(u.length,o.getUint8(e));i>m;)c=r[""+this.encode(u[m][0])],(!n||c)&&(o.setUint16(e+2+4*m,c||0),o.setUint8(e+4+4*m,u[m][0].length),o.setUint8(e+5+4*m,u[m][1])),m++;o.setUint8(e+1,m)},keyinput:function(t){var e=t.charCode,r=t.keyCode,n=function(){for(var t={8:8,13:13,27:27,37:131,38:129,39:132,40:130},e=96;106>e;)t[e]=49+e++;for(e=112;124>e;)t[e]=21+e++;return t}();return n[r]?n[r]:this.reverse_unicode_table[e]||63},disassemble:function(){function t(t,e){for(var r=0;4>r;r++)e.push((192&t)>>6),t<<=2}for(var e,r,n,s,i,o,a,_=this.m,h=new R(this,this.pc);;){if(r=e=this.pc,s=_.getUint8(e++),190===s?(o=-1,s=_.getUint8(e++)+1e3):128&s?64&s?(o=-1,32&s||(s&=31)):(o=[(48&s)>>4],3>o[0]&&(s&=207)):(o=[64&s?2:1,32&s?2:1],s&=31),!D[s])throw this.stop=1,Error("Unknown opcode #"+s+" at pc="+r);for(i=D[s].prototype,-1===o&&(o=[],t(_.getUint8(e++),o),(236===s||250===s)&&t(_.getUint8(e++),o)),a=[],n=0;o.length>n;)0===o[n]&&(a.push(new C(this,_.getUint16(e))),e+=2),1===o[n]&&a.push(new C(this,_.getUint8(e++))),2===o[n++]&&a.push(new S(this,_.getUint8(e++)));if(i.storer&&a.push(new S(this,_.getUint8(e++))),i.brancher&&(n=_.getUint8(e++),a.push([128&n,64&n?63&n:(n<<8|_.getUint8(e++))<<18>>18])),i.printer)for(a.push(e);this.eof>e&&(n=_.getUint8(e),e+=2,!(128&n)););if(this.pc=e,h.ops.push(new D[s](this,h,s,r,e,a)),n=0,h.targets.indexOf(e)>=0&&(n=l(h,e)),i.stopper&&!n)break}return h},init:function(){this.jit={},this.env={width:80},c(this,["find_prop"])},inputEvent:function(t){var e,r=this.m,n=t.code;if(!t.env||(i(this.env,t.env),n)){if("load"===n)return this.data=t.data,void 0;this.orders=[],"restart"===n&&this.restart(),"save"===n&&this.variable(t.storer,t.result||1),"restore"===n&&(this.m||this.restart(),t.data?this.restore(t.data):this.variable(t.storer,0)),"read"===n&&(this.variable(t.storer,isNaN(t.terminator)?13:t.terminator),e=t.response,this._print(e+"\r"),e=this.text_to_zscii(e.toLowerCase()),e.length>t.len&&(e=e.slice(0,t.len)),r.setUint8(t.buffer+1,e.length),r.setBuffer(t.buffer+2,e),t.parse&&this.tokenise(t.buffer,t.parse)),"char"===n&&this.variable(t.storer,this.keyinput(t.response)),"get_cursor"===n&&(r.setUint16(t.addr,t.pos[0]+1),r.setUint16(t.addr+2,t.pos[1]+1)),this.run()}},run:function(){var t,e,r=new Date,n=0;for(this.stop=0;!this.stop;)if(t=this.pc,this.jit[t]||this.compile(),e=this.jit[t](this),isNaN(e)||this.ret(e),0===++n%5e4&&new Date-r>5e3)return this.act("tick"),void 0},compile:function(){var t=this.disassemble(),e,r;this.jit[t.pc]=Function("e",h(""+t)),t.pc<this.staticmem&&v.warn("Caching a JIT function in dynamic memory: "+t.pc)},act:function(t,e){e=e||{},183===t&&(t="restart"),186===t&&(t="quit"),1001===t&&(t="restore",e={storer:e}),this.ui.flush(),this.ui.status.length&&(this.orders.push({code:"stream",to:"status",data:this.ui.status}),this.ui.status=[]),e.code=t,this.orders.push(e),this.stop=1,this.outputEvent&&this.outputEvent(this.orders)}});return M.ZVMUI=z,"object"==typeof module&&"object"==typeof module.exports&&(module.exports=M),M}();